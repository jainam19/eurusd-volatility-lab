---
title: "EUR/USD Volatility Lab — ARIMA + GARCH"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 9, fig.height = 6, dpi = 120)
suppressPackageStartupMessages({
  library(tidyverse); library(lubridate); library(readr)
  library(ggplot2); library(ggfortify)
  library(forecast); library(tseries); library(FinTS)
  library(here)
})
# Anchor knitting to the project root
knitr::opts_knit$set(root.dir = here::here())
setwd(here::here())
source(here::here("src","helpers.R"))
set.seed(7)
```

# 1. Data
```{r data}
df <- read_eurusd()
glimpse(head(df, 5))
```

## 1.1 Returns
```{r returns}
ret <- compute_returns(df)
autoplot(ret, aes(x = date, y = ret)) + ggtitle("EUR/USD log returns")
```

# 2. Stationarity & diagnostics
```{r tests}
adf_p <- tseries::adf.test(ret$ret)$p.value
kpss_p <- tseries::kpss.test(ret$ret)$p.value
cat(sprintf("ADF p=%.3f | KPSS p=%.3f\n", adf_p, kpss_p))
forecast::Acf(ret$ret, main = "ACF of returns")
forecast::Pacf(ret$ret, main = "PACF of returns")
FinTS::ArchTest(ret$ret, lags = 12)
```

# 3. Train/Test split
```{r split}
cut_date <- ret$date[floor(nrow(ret)*0.8)]
train <- ret |> dplyr::filter(date <= cut_date)
test  <- ret |> dplyr::filter(date >  cut_date)
cat(sprintf("Train: %s to %s (%d obs)\n", min(train$date), max(train$date), nrow(train)))
cat(sprintf("Test:  %s to %s (%d obs)\n", min(test$date),  max(test$date),  nrow(test)))
```

# 4. Mean model — ARIMA
```{r arima}
fit_arima <- forecast::auto.arima(train$ret, seasonal = FALSE, stepwise = TRUE, approximation = TRUE)
fit_arima
forecast::checkresiduals(fit_arima)
fc_mean <- forecast::Arima(train$ret, model = fit_arima) |> forecast::forecast(h = nrow(test))
plot(fc_mean); lines(test$ret, col = "red")
```

# 5. Volatility model — GARCH(1,1) (illustrative)
```{r garch, message=TRUE}
sigma_hat <- rep(stats::sd(train$ret), nrow(train))  # fallback
if (requireNamespace("rugarch", quietly = TRUE)) {
  library(rugarch)
  spec <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1,1)),
                     mean.model = list(armaOrder = c(0,0), include.mean = FALSE),
                     distribution.model = "sstd")
  gfit <- ugarchfit(spec, data = train$ret)
  sigma_hat <- as.numeric(sigma(gfit))
} else if (requireNamespace("fGarch", quietly = TRUE)) {
  library(fGarch)
  gfit <- garch(train$ret, order = c(1,1))
  sigma_hat <- as.numeric(gfit@sigma.t)
} else {
  message("Neither rugarch nor fGarch installed — using constant volatility for illustration.")
}
plot(sigma_hat, type="l", main="Estimated volatility (train)")
```

# 6. Risk metrics — VaR/ES (illustrative)
```{r var}
alpha <- 0.95
sigma_last <- tail(sigma_hat, 1)
q <- qnorm(alpha, mean = 0, sd = sigma_last)
es <- (dnorm(q) / (1 - alpha)) * sigma_last
cat(sprintf("Illustrative 1-day VaR@95%%: %.4f | ES: %.4f\n", q, es))
```

# 7. Key figure
```{r key-plot, fig.cap="Returns (train) — replace with volatility or VaR breaches chart"}
autoplot(train, aes(x = date, y = ret)) + ggtitle("EUR/USD returns (train)")
ggsave(here::here("figs","key_plot.png"), width = 9, height = 6, dpi = 150)
```

# 8. Next steps
- Replace illustrative VaR with **rolling** ARIMA+GARCH forecasts on the test window.
- Add coverage backtests (Kupiec, Christoffersen) and a breaches plot.
- Compare baseline RW vs ARIMA vs ARIMA+GARCH.
